/**
 * Menu Interativo CLI
 * 
 * Interface amig√°vel para sele√ß√£o de fontes de scraping,
 * configura√ß√µes regionais e op√ß√µes de execu√ß√£o.
 * 
 * FOCO: Ji-Paran√°/RO + Artistas Famosos do Brasil
 * POL√çTICA: Apenas eventos reais, sem dados fict√≠cios
 */

const inquirer = require('inquirer');
const chalk = require('chalk');
const { Logger } = require('../utils/logger');
const config = require('../utils/config');

class InteractiveMenu {
  constructor() {
    this.logger = new Logger('menu');
    this.selectedSources = [];
    this.regionConfig = null;
    this.scrapingOptions = {
      maxEvents: 50,
      categories: [],
      dateRange: 'next_30_days',
      requireImages: true,
      onlyRegional: false
    };
  }

  /**
   * Exibe banner inicial do sistema
   */
  showBanner() {
    console.log('\n' + chalk.cyan('üé´ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'));
    console.log(chalk.cyan('   SISTEMA DE SCRAPING DE EVENTOS BRASIL'));
    console.log(chalk.cyan('   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'));
    console.log(chalk.gray('   üìç Foco: Ji-Paran√°/RO + Artistas Famosos do Brasil'));
    console.log(chalk.gray('   ‚úÖ Pol√≠tica: Apenas eventos reais, sem dados fict√≠cios'));
    console.log(chalk.gray('   üîí Sistema autenticado e seguro\n'));
  }

  /**
   * Menu principal do sistema
   */
  async showMainMenu() {
    this.showBanner();

    const mainMenuChoices = [
      {
        name: 'üéØ Configurar Scraping Completo',
        value: 'full_setup',
        short: 'Setup Completo'
      },
      {
        name: 'üï∑Ô∏è  Scraping R√°pido (Configura√ß√£o Padr√£o)',
        value: 'quick_scraping',
        short: 'Scraping R√°pido'
      },
      {
        name: '‚öôÔ∏è  Configura√ß√µes Avan√ßadas',
        value: 'advanced_config',
        short: 'Configura√ß√µes'
      },
      {
        name: 'üìä Ver Estat√≠sticas do Sistema',
        value: 'view_stats',
        short: 'Estat√≠sticas'
      },
      {
        name: '‚ùå Sair',
        value: 'exit',
        short: 'Sair'
      }
    ];

    const { action } = await inquirer.prompt([
      {
        type: 'list',
        name: 'action',
        message: 'O que voc√™ gostaria de fazer?',
        choices: mainMenuChoices,
        pageSize: 10
      }
    ]);

    switch (action) {
      case 'full_setup':
        return await this.fullSetupFlow();
      case 'quick_scraping':
        return await this.quickScrapingFlow();
      case 'advanced_config':
        return await this.advancedConfigFlow();
      case 'view_stats':
        return await this.viewStatsFlow();
      case 'exit':
        return this.exitFlow();
      default:
        return await this.showMainMenu();
    }
  }

  /**
   * Fluxo de configura√ß√£o completa
   */
  async fullSetupFlow() {
    console.log(chalk.yellow('\nüéØ Configura√ß√£o Completa de Scraping'));
    console.log(chalk.gray('Vamos configurar todos os aspectos do scraping passo a passo.\n'));

    // 1. Sele√ß√£o de fontes
    await this.selectSources();

    // 2. Configura√ß√£o regional
    await this.configureRegion();

    // 3. Configura√ß√£o de categorias
    await this.selectCategories();

    // 4. Configura√ß√µes de qualidade
    await this.configureQuality();

    // 5. Configura√ß√µes de quantidade
    await this.configureQuantity();

    // 6. Confirma√ß√£o final
    return await this.confirmConfiguration();
  }

  /**
   * Fluxo de scraping r√°pido
   */
  async quickScrapingFlow() {
    console.log(chalk.yellow('\nüï∑Ô∏è  Scraping R√°pido'));
    console.log(chalk.gray('Usando configura√ß√µes padr√£o otimizadas para Ji-Paran√°/RO.\n'));

    // Configura√ß√£o padr√£o
    this.selectedSources = ['eventbrite', 'sympla'];
    this.regionConfig = 'jiparana_and_national';
    this.scrapingOptions = {
      maxEvents: 30,
      categories: ['shows', 'teatro', 'gastronomia'],
      dateRange: 'next_30_days',
      requireImages: true,
      onlyRegional: false
    };

    console.log(chalk.green('‚úÖ Configura√ß√£o padr√£o aplicada:'));
    console.log(`   üìç Regi√£o: Ji-Paran√°/RO + Eventos Nacionais`);
    console.log(`   üé™ Fontes: Eventbrite + Sympla`);
    console.log(`   üìä M√°ximo: ${this.scrapingOptions.maxEvents} eventos`);
    console.log(`   üé≠ Categorias: Shows, Teatro, Gastronomia`);
    console.log(`   üìÖ Per√≠odo: Pr√≥ximos 30 dias`);

    const { confirm } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'confirm',
        message: 'Iniciar scraping com essas configura√ß√µes?',
        default: true
      }
    ]);

    if (confirm) {
      return {
        action: 'start_scraping',
        config: this.buildFinalConfig()
      };
    } else {
      return await this.showMainMenu();
    }
  }

  /**
   * Sele√ß√£o de fontes de scraping
   */
  async selectSources() {
    console.log(chalk.yellow('üì° Sele√ß√£o de Fontes de Dados\n'));

    const sourceChoices = [
      {
        name: 'üé´ Eventbrite Brasil (Recomendado)',
        value: 'eventbrite',
        checked: true
      },
      {
        name: 'üé™ Sympla Brasil (Recomendado)',
        value: 'sympla',
        checked: true
      }
    ];

    const { sources } = await inquirer.prompt([
      {
        type: 'checkbox',
        name: 'sources',
        message: 'Selecione as fontes de dados para scraping:',
        choices: sourceChoices,
        validate: (input) => {
          if (input.length === 0) {
            return 'Selecione pelo menos uma fonte de dados.';
          }
          return true;
        }
      }
    ]);

    this.selectedSources = sources;

    console.log(chalk.green(`\n‚úÖ Fontes selecionadas: ${sources.map(s => 
      s === 'eventbrite' ? 'Eventbrite' : 'Sympla'
    ).join(', ')}`));

    return sources;
  }

  /**
   * Configura√ß√£o regional
   */
  async configureRegion() {
    console.log(chalk.yellow('\nüìç Configura√ß√£o Regional\n'));

    const regionChoices = [
      {
        name: 'üéØ Ji-Paran√°/RO + Eventos Nacionais (Recomendado)',
        value: 'jiparana_and_national',
        short: 'Ji-Paran√° + Nacional'
      },
      {
        name: 'üè† Apenas Ji-Paran√° e Regi√£o',
        value: 'jiparana_only',
        short: 'Apenas Regional'
      },
      {
        name: 'üåé Apenas Eventos Nacionais',
        value: 'national_only',
        short: 'Apenas Nacional'
      },
      {
        name: 'üîß Configura√ß√£o Personalizada',
        value: 'custom',
        short: 'Personalizada'
      }
    ];

    const { region } = await inquirer.prompt([
      {
        type: 'list',
        name: 'region',
        message: 'Selecione o foco regional:',
        choices: regionChoices
      }
    ]);

    if (region === 'custom') {
      return await this.customRegionConfig();
    }

    this.regionConfig = region;

    const regionDescriptions = {
      'jiparana_and_national': 'Ji-Paran√°/RO, cidades vizinhas e eventos de artistas famosos do Brasil',
      'jiparana_only': 'Apenas Ji-Paran√°, Ariquemes, Cacoal, Rolim de Moura, Vilhena',
      'national_only': 'Apenas eventos nacionais de artistas famosos'
    };

    console.log(chalk.green(`\n‚úÖ Configura√ß√£o regional: ${regionDescriptions[region]}`));

    return region;
  }

  /**
   * Configura√ß√£o regional personalizada
   */
  async customRegionConfig() {
    console.log(chalk.yellow('\nüîß Configura√ß√£o Regional Personalizada\n'));

    const { includeJiparana, includeNearby, includeNational, customCities } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'includeJiparana',
        message: 'Incluir eventos de Ji-Paran√°?',
        default: true
      },
      {
        type: 'confirm',
        name: 'includeNearby',
        message: 'Incluir cidades vizinhas (Ariquemes, Cacoal, etc.)?',
        default: true,
        when: (answers) => answers.includeJiparana
      },
      {
        type: 'confirm',
        name: 'includeNational',
        message: 'Incluir eventos nacionais de artistas famosos?',
        default: true
      },
      {
        type: 'input',
        name: 'customCities',
        message: 'Cidades adicionais (separadas por v√≠rgula):',
        when: (answers) => answers.includeJiparana || answers.includeNearby
      }
    ]);

    this.regionConfig = {
      type: 'custom',
      includeJiparana,
      includeNearby,
      includeNational,
      customCities: customCities ? customCities.split(',').map(c => c.trim()) : []
    };

    console.log(chalk.green('\n‚úÖ Configura√ß√£o regional personalizada salva'));

    return this.regionConfig;
  }

  /**
   * Sele√ß√£o de categorias
   */
  async selectCategories() {
    console.log(chalk.yellow('\nüé≠ Sele√ß√£o de Categorias de Eventos\n'));

    const categoryChoices = Object.entries(config.categories).map(([key, category]) => ({
      name: `${category.icon} ${category.name}`,
      value: key,
      checked: ['shows', 'teatro', 'gastronomia'].includes(key)
    }));

    const { categories } = await inquirer.prompt([
      {
        type: 'checkbox',
        name: 'categories',
        message: 'Selecione as categorias de interesse:',
        choices: categoryChoices,
        validate: (input) => {
          if (input.length === 0) {
            return 'Selecione pelo menos uma categoria.';
          }
          return true;
        }
      }
    ]);

    this.scrapingOptions.categories = categories;

    console.log(chalk.green(`\n‚úÖ Categorias selecionadas: ${categories.length} categoria(s)`));

    return categories;
  }

  /**
   * Configura√ß√µes de qualidade
   */
  async configureQuality() {
    console.log(chalk.yellow('\n‚ú® Configura√ß√µes de Qualidade\n'));

    const { requireImages, requireDescription, minTitleLength } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'requireImages',
        message: 'Exigir que eventos tenham imagens?',
        default: true
      },
      {
        type: 'confirm',
        name: 'requireDescription',
        message: 'Exigir que eventos tenham descri√ß√£o?',
        default: false
      },
      {
        type: 'list',
        name: 'minTitleLength',
        message: 'Tamanho m√≠nimo do t√≠tulo do evento:',
        choices: [
          { name: '5 caracteres (Muito permissivo)', value: 5 },
          { name: '10 caracteres (Recomendado)', value: 10 },
          { name: '15 caracteres (Rigoroso)', value: 15 }
        ],
        default: 10
      }
    ]);

    this.scrapingOptions.requireImages = requireImages;
    this.scrapingOptions.requireDescription = requireDescription;
    this.scrapingOptions.minTitleLength = minTitleLength;

    console.log(chalk.green('\n‚úÖ Configura√ß√µes de qualidade definidas'));

    return { requireImages, requireDescription, minTitleLength };
  }

  /**
   * Configura√ß√µes de quantidade
   */
  async configureQuantity() {
    console.log(chalk.yellow('\nüìä Configura√ß√µes de Quantidade\n'));

    const { maxEvents, dateRange } = await inquirer.prompt([
      {
        type: 'list',
        name: 'maxEvents',
        message: 'M√°ximo de eventos para coletar:',
        choices: [
          { name: '20 eventos (R√°pido)', value: 20 },
          { name: '50 eventos (Recomendado)', value: 50 },
          { name: '100 eventos (Completo)', value: 100 },
          { name: '200 eventos (Extensivo)', value: 200 }
        ],
        default: 50
      },
      {
        type: 'list',
        name: 'dateRange',
        message: 'Per√≠odo de eventos:',
        choices: [
          { name: 'Pr√≥ximos 15 dias', value: 'next_15_days' },
          { name: 'Pr√≥ximos 30 dias (Recomendado)', value: 'next_30_days' },
          { name: 'Pr√≥ximos 60 dias', value: 'next_60_days' },
          { name: 'Pr√≥ximos 90 dias', value: 'next_90_days' }
        ],
        default: 'next_30_days'
      }
    ]);

    this.scrapingOptions.maxEvents = maxEvents;
    this.scrapingOptions.dateRange = dateRange;

    console.log(chalk.green(`\n‚úÖ Configurado para coletar at√© ${maxEvents} eventos dos pr√≥ximos ${dateRange.replace('next_', '').replace('_days', ' dias')}`));

    return { maxEvents, dateRange };
  }

  /**
   * Confirma√ß√£o final da configura√ß√£o
   */
  async confirmConfiguration() {
    console.log(chalk.yellow('\nüìã Resumo da Configura√ß√£o\n'));

    const summary = this.buildConfigSummary();
    console.log(summary);

    const { confirm, saveConfig } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'confirm',
        message: 'Confirma essa configura√ß√£o e inicia o scraping?',
        default: true
      },
      {
        type: 'confirm',
        name: 'saveConfig',
        message: 'Salvar essa configura√ß√£o como padr√£o?',
        default: false,
        when: (answers) => answers.confirm
      }
    ]);

    if (!confirm) {
      const { action } = await inquirer.prompt([
        {
          type: 'list',
          name: 'action',
          message: 'O que gostaria de fazer?',
          choices: [
            { name: 'üîÑ Reconfigurar', value: 'reconfigure' },
            { name: 'üè† Voltar ao menu principal', value: 'main_menu' },
            { name: '‚ùå Sair', value: 'exit' }
          ]
        }
      ]);

      switch (action) {
        case 'reconfigure':
          return await this.fullSetupFlow();
        case 'main_menu':
          return await this.showMainMenu();
        case 'exit':
          return this.exitFlow();
      }
    }

    return {
      action: 'start_scraping',
      config: this.buildFinalConfig(),
      saveAsDefault: saveConfig
    };
  }

  /**
   * Constr√≥i resumo da configura√ß√£o
   */
  buildConfigSummary() {
    const sources = this.selectedSources.map(s => 
      s === 'eventbrite' ? 'Eventbrite' : 'Sympla'
    ).join(', ');

    const regionText = typeof this.regionConfig === 'string' ? 
      {
        'jiparana_and_national': 'Ji-Paran√°/RO + Nacional',
        'jiparana_only': 'Apenas Ji-Paran√°/RO',
        'national_only': 'Apenas Nacional'
      }[this.regionConfig] : 'Personalizada';

    const categories = this.scrapingOptions.categories.map(c => 
      config.categories[c]?.name || c
    ).join(', ');

    return chalk.cyan('üìã CONFIGURA√á√ÉO FINAL:') + '\n' +
           chalk.gray('‚îÄ'.repeat(50)) + '\n' +
           chalk.white(`üì° Fontes: ${sources}\n`) +
           chalk.white(`üìç Regi√£o: ${regionText}\n`) +
           chalk.white(`üé≠ Categorias: ${categories}\n`) +
           chalk.white(`üìä M√°ximo: ${this.scrapingOptions.maxEvents} eventos\n`) +
           chalk.white(`üìÖ Per√≠odo: ${this.scrapingOptions.dateRange.replace('next_', '').replace('_days', ' dias')}\n`) +
           chalk.white(`‚ú® Imagens obrigat√≥rias: ${this.scrapingOptions.requireImages ? 'Sim' : 'N√£o'}\n`) +
           chalk.gray('‚îÄ'.repeat(50));
  }

  /**
   * Constr√≥i configura√ß√£o final
   */
  buildFinalConfig() {
    return {
      sources: this.selectedSources,
      region: this.regionConfig,
      options: this.scrapingOptions,
      timestamp: new Date().toISOString()
    };
  }

  /**
   * Fluxo de configura√ß√µes avan√ßadas
   */
  async advancedConfigFlow() {
    console.log(chalk.yellow('\n‚öôÔ∏è  Configura√ß√µes Avan√ßadas\n'));
    console.log(chalk.gray('Funcionalidade em desenvolvimento...'));
    
    const { action } = await inquirer.prompt([
      {
        type: 'list',
        name: 'action',
        message: 'O que gostaria de fazer?',
        choices: [
          { name: 'üè† Voltar ao menu principal', value: 'main_menu' },
          { name: '‚ùå Sair', value: 'exit' }
        ]
      }
    ]);

    if (action === 'main_menu') {
      return await this.showMainMenu();
    } else {
      return this.exitFlow();
    }
  }

  /**
   * Fluxo de visualiza√ß√£o de estat√≠sticas
   */
  async viewStatsFlow() {
    console.log(chalk.yellow('\nüìä Estat√≠sticas do Sistema\n'));
    console.log(chalk.gray('Funcionalidade em desenvolvimento...'));
    
    const { action } = await inquirer.prompt([
      {
        type: 'list',
        name: 'action',
        message: 'O que gostaria de fazer?',
        choices: [
          { name: 'üè† Voltar ao menu principal', value: 'main_menu' },
          { name: '‚ùå Sair', value: 'exit' }
        ]
      }
    ]);

    if (action === 'main_menu') {
      return await this.showMainMenu();
    } else {
      return this.exitFlow();
    }
  }

  /**
   * Fluxo de sa√≠da
   */
  exitFlow() {
    console.log(chalk.yellow('\nüëã Obrigado por usar o Sistema de Scraping de Eventos Brasil!'));
    console.log(chalk.gray('Sistema encerrado com seguran√ßa.\n'));
    
    return {
      action: 'exit',
      message: 'Sistema encerrado pelo usu√°rio'
    };
  }
}

module.exports = { InteractiveMenu };